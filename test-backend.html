<!DOCTYPE html>
<html>
<head>
    <title>Backend Connection Test</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .box { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Backend Connection Diagnostic</h1>
    
    <div class="box">
        <h2>Test 1: Backend Health Check</h2>
        <button onclick="testHealth()">Test Backend Health</button>
        <pre id="health-result">Click button to test...</pre>
    </div>

    <div class="box">
        <h2>Test 2: Products API</h2>
        <button onclick="testProducts()">Test Products Endpoint</button>
        <pre id="products-result">Click button to test...</pre>
    </div>

    <div class="box">
        <h2>Test 3: Admin Login</h2>
        <button onclick="testLogin()">Test Admin Login</button>
        <pre id="login-result">Click button to test...</pre>
    </div>

    <div class="box">
        <h2>Test 4: Complete Login Flow</h2>
        <input type="text" id="username" placeholder="Username" value="Sohang" style="padding: 8px; margin: 5px; width: 200px;">
        <input type="password" id="password" placeholder="Password" value="Sohang@1911" style="padding: 8px; margin: 5px; width: 200px;">
        <button onclick="fullLoginTest()">Full Login Test</button>
        <pre id="full-result">Enter credentials and test...</pre>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001/api';

        async function testHealth() {
            const result = document.getElementById('health-result');
            result.textContent = '‚è≥ Testing...';
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                result.innerHTML = `<span class="success">‚úÖ SUCCESS!</span>\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå FAILED!</span>\nError: ${error.message}`;
            }
        }

        async function testProducts() {
            const result = document.getElementById('products-result');
            result.textContent = '‚è≥ Testing...';
            
            try {
                const response = await fetch(`${API_BASE}/products`);
                const data = await response.json();
                result.innerHTML = `<span class="success">‚úÖ SUCCESS!</span>\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå FAILED!</span>\nError: ${error.message}`;
            }
        }

        async function testLogin() {
            const result = document.getElementById('login-result');
            result.textContent = '‚è≥ Testing...';
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'Sohang',
                        password: 'Sohang@1911'
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `<span class="success">‚úÖ LOGIN SUCCESS!</span>\nToken: ${data.token.substring(0, 50)}...\nUser: ${data.user.username}`;
                } else {
                    result.innerHTML = `<span class="error">‚ùå LOGIN FAILED!</span>\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå CONNECTION FAILED!</span>\nError: ${error.message}`;
            }
        }

        async function fullLoginTest() {
            const result = document.getElementById('full-result');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            result.textContent = '‚è≥ Running full test...';
            
            let log = '';
            
            // Step 1: Health Check
            log += 'üìç Step 1: Health Check\n';
            try {
                const health = await fetch(`${API_BASE}/health`);
                const healthData = await health.json();
                log += `‚úÖ Backend is running: ${healthData.message}\n\n`;
            } catch (error) {
                log += `‚ùå Backend not reachable: ${error.message}\n\n`;
                result.textContent = log;
                return;
            }
            
            // Step 2: Login
            log += 'üìç Step 2: Attempting Login\n';
            try {
                const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const loginData = await loginResponse.json();
                
                if (loginData.success) {
                    log += `‚úÖ Login successful!\n`;
                    log += `   Username: ${loginData.user.username}\n`;
                    log += `   Email: ${loginData.user.email}\n`;
                    log += `   Token: ${loginData.token.substring(0, 30)}...\n\n`;
                    
                    // Step 3: Verify Token
                    log += 'üìç Step 3: Verifying Token\n';
                    const verifyResponse = await fetch(`${API_BASE}/auth/verify`, {
                        headers: { 'Authorization': `Bearer ${loginData.token}` }
                    });
                    const verifyData = await verifyResponse.json();
                    
                    if (verifyData.success) {
                        log += `‚úÖ Token verified!\n\n`;
                        log += 'üéâ ALL TESTS PASSED!\n';
                        log += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                        log += 'Your backend is working perfectly!\n';
                        log += 'You can now login to admin panel.\n';
                        result.innerHTML = `<span class="success">${log}</span>`;
                    } else {
                        log += `‚ùå Token verification failed\n`;
                        result.innerHTML = `<span class="error">${log}</span>`;
                    }
                } else {
                    log += `‚ùå Login failed: ${loginData.message}\n`;
                    result.innerHTML = `<span class="error">${log}</span>`;
                }
            } catch (error) {
                log += `‚ùå Login request failed: ${error.message}\n`;
                result.innerHTML = `<span class="error">${log}</span>`;
            }
        }

        // Auto-run health check on load
        window.onload = () => {
            setTimeout(testHealth, 500);
        };
    </script>
</body>
</html>
